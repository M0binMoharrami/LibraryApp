<!doctype html>
<html lang="fa" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…Ø¯Ø±Ø³Ù‡</title><!-- SDK scripts removed - now using Flask REST API -->
  <script src="../static/3.4.17.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Tahoma', 'Arial', sans-serif;
        }
        .rtl {
            direction: rtl;
        }
        .overdue {
            background-color: #fee2e2;
            border-color: #fca5a5;
        }
        .due-soon {
            background-color: #fef3c7;
            border-color: #fcd34d;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-blue-50 to-indigo-100 rtl">
  <div class="min-h-full"><!-- Header -->
   <header class="bg-white shadow-lg border-b-4 border-blue-600">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
     <div class="text-center">
      <h1 id="library-title" class="text-3xl font-bold text-gray-900 mb-2">Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…Ø¯Ø±Ø³Ù‡</h1>
      <p id="welcome-message" class="text-lg text-gray-600">Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…Ø¯Ø±Ø³Ù‡ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</p>
      <p class="text-sm text-gray-500 mt-2">Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· ØªÛŒÙ… Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³Ø§Ù† Ù…Ø¯Ø±Ø³Ù‡ Ø´Ø§Ù‡Ø¯ Ø¨Ø±Ø§Ø¯Ø±Ø§Ù† Ø§Ù‡Ù†Ø¯ÙˆØ³Øª | <a href="https://github.com/M0binMoharrami/LibraryApp/" id="project-link" class="text-blue-600 hover:text-blue-800 underline">Ù¾Ø±ÙˆÚ˜Ù‡ Ø¯Ø± Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨</a></p>
     </div>
    </div>
   </header><!-- Navigation -->
   <nav class="bg-blue-600 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
     <div class="flex justify-center space-x-reverse space-x-8"><button onclick="showSection('books')" id="books-tab" class="nav-btn px-6 py-4 text-white font-medium border-b-2 border-transparent hover:border-white transition-colors"> ğŸ“š Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ </button> <button onclick="showSection('students')" id="students-tab" class="nav-btn px-6 py-4 text-white font-medium border-b-2 border-transparent hover:border-white transition-colors"> ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† </button> <button onclick="showSection('loans')" id="loans-tab" class="nav-btn px-6 py-4 text-white font-medium border-b-2 border-transparent hover:border-white transition-colors"> ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ </button> <button onclick="showSection('overdue')" id="overdue-tab" class="nav-btn px-6 py-4 text-white font-medium border-b-2 border-transparent hover:border-white transition-colors"> âš ï¸ Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚Ù‡ </button>
     </div>
    </div>
   </nav><!-- Main Content -->
   <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><!-- Books Section -->
    <div id="books-section" class="section">
     <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨ Ø¬Ø¯ÛŒØ¯</h2>
      <form id="book-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label for="book-title" class="block text-sm font-medium text-gray-700 mb-1">Ø¹Ù†ÙˆØ§Ù† Ú©ØªØ§Ø¨</label> <input type="text" id="book-title" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label for="book-author" class="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</label> <input type="text" id="book-author" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label for="book-copies" class="block text-sm font-medium text-gray-700 mb-1">ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡</label> <input type="number" id="book-copies" min="1" value="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div class="flex items-end"><button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"> Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨ </button>
       </div>
      </form>
     </div>
     <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-2xl font-bold text-gray-900">Ù„ÛŒØ³Øª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</h2>
       <div class="w-1/3"><input type="text" id="books-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©ØªØ§Ø¨â€ŒÙ‡Ø§..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
      </div>
      <div id="books-list" class="space-y-3"><!-- Books will be displayed here -->
      </div>
     </div>
    </div><!-- Students Section -->
    <div id="students-section" class="section hidden">
     <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¬Ø¯ÛŒØ¯</h2>
      <form id="student-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label> <input type="text" id="student-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label for="student-id" class="block text-sm font-medium text-gray-700 mb-1">Ú©Ø¯ Ù…Ù„ÛŒ</label> <input type="text" id="student-id" required maxlength="10" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label for="student-email" class="block text-sm font-medium text-gray-700 mb-1">Ø§ÛŒÙ…ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label> <input type="email" id="student-email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div class="flex items-end"><button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors"> Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² </button>
       </div>
      </form>
     </div>
     <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-2xl font-bold text-gray-900">Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</h2>
       <div class="w-1/3"><input type="text" id="students-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
      </div>
      <div id="students-list" class="space-y-3"><!-- Students will be displayed here -->
      </div>
     </div>
    </div><!-- Loans Section -->
    <div id="loans-section" class="section hidden">
     <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª Ø¬Ø¯ÛŒØ¯</h2>
      <form id="loan-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
       <div><label for="loan-book" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù†ØªØ®Ø§Ø¨ Ú©ØªØ§Ø¨</label> <select id="loan-book" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">Ú©ØªØ§Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option> </select>
       </div>
       <div><label for="loan-student" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</label> <select id="loan-student" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option> </select>
       </div>
       <div class="flex items-end"><button type="submit" class="w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors"> Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª </button>
       </div>
      </form>
     </div>
     <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-2xl font-bold text-gray-900">Ù„ÛŒØ³Øª Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§</h2>
       <div class="w-1/3"><input type="text" id="loans-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
      </div>
      <div id="loans-list" class="space-y-3"><!-- Loans will be displayed here -->
      </div>
     </div>
    </div><!-- Overdue Loans Section -->
    <div id="overdue-section" class="section hidden">
     <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
       <h2 class="text-2xl font-bold text-red-600">Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚Ù‡</h2>
       <div class="flex items-center space-x-reverse space-x-4"><span id="overdue-count" class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">0 Ù…ÙˆØ±Ø¯</span> <button onclick="loadAllData()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"> ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ </button>
       </div>
      </div>
      <div id="overdue-list" class="space-y-4"><!-- Overdue loans will be displayed here -->
      </div>
     </div>
    </div>
   </main>
  </div>
  <script>
        // ========================================
        // GLOBAL VARIABLES & CONFIG
        // ========================================
        let allBooks = [];
        let allStudents = [];
        let allLoans = [];
        let filteredBooks = [];
        let filteredStudents = [];
        let filteredLoans = [];

        // ========================================
        // API FUNCTIONS - FLASK BACKEND INTEGRATION
        // ========================================
        
        // Load all data from Flask backend
        async function loadAllData() {
            try {
                // Load books
                const booksResponse = await fetch('/api/books/list');
                if (booksResponse.ok) {
                    allBooks = await booksResponse.json();
                    filteredBooks = allBooks;
                } else {
                    allBooks = [];
                    filteredBooks = [];
                }

                // Load students
                const studentsResponse = await fetch('/api/students/list');
                if (studentsResponse.ok) {
                    allStudents = await studentsResponse.json();
                    filteredStudents = allStudents;
                } else {
                    allStudents = [];
                    filteredStudents = [];
                }

                // Load loans
                const loansResponse = await fetch('/api/loans/list');
                if (loansResponse.ok) {
                    allLoans = await loansResponse.json();
                    filteredLoans = allLoans;
                } else {
                    allLoans = [];
                    filteredLoans = [];
                }

                // Render all sections
                renderBooks(filteredBooks);
                renderStudents(filteredStudents);
                renderLoans(filteredLoans, allBooks, allStudents);
                renderOverdueLoans(allLoans, allBooks, allStudents);
                updateLoanSelects(allBooks, allStudents);

            } catch (error) {
                console.error('Error loading data:', error);
                showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', 'error');
            }
        }

        // Initialize app
        async function initializeApp() {
            await loadAllData();
        }



        // ========================================
        // BOOKS MANAGEMENT SECTION
        // ========================================
        
        // Add new book
        document.getElementById('book-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù†...';

            const totalCopies = parseInt(document.getElementById('book-copies').value);
            
            // Flask API Integration: POST to /api/books/add
            const bookData = {
                title: document.getElementById('book-title').value,        // VARCHAR(255) - Ø¹Ù†ÙˆØ§Ù† Ú©ØªØ§Ø¨
                author: document.getElementById('book-author').value,      // VARCHAR(255) - Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡
                total_copies: totalCopies,                                // INTEGER - ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§
                available_copies: totalCopies                             // INTEGER - ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
            };

            try {
                const response = await fetch('/api/books/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookData)
                });

                if (response.ok) {
                    e.target.reset();
                    showMessage('Ú©ØªØ§Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
                    await loadAllData(); // Refresh data
                } else {
                    const errorData = await response.json();
                    showMessage(errorData.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨', 'error');
                }
            } catch (error) {
                console.error('Error adding book:', error);
                showMessage(error, 'error');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨';
        });

        // Search books
        document.getElementById('books-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm === '') {
                filteredBooks = allBooks;
            } else {
                filteredBooks = allBooks.filter(book => 
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm)
                );
            }
            
            renderBooks(filteredBooks);
        });

        // Delete book
        async function deleteBook(bookId) {
    try {
        const response = await fetch(`/api/books/delete/${bookId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
            showMessage(data.message || 'Ú©ØªØ§Ø¨ Ø­Ø°Ù Ø´Ø¯', 'success');
            await loadAllData(); // Refresh data
        } else {
            showMessage(data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©ØªØ§Ø¨', 'error');
        }
    } catch (error) {
        console.error('Error deleting book:', error);
        showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
    }
}


        // ========================================
        // STUDENTS MANAGEMENT SECTION
        // ========================================
        
        // Add new student
        document.getElementById('student-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù†...';

            // Flask API Integration: POST to /api/students/add
            const studentData = {
                name: document.getElementById('student-name').value,           // VARCHAR(255) - Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ
                national_id: document.getElementById('student-id').value,     // VARCHAR(10) UNIQUE - Ú©Ø¯ Ù…Ù„ÛŒ (Ø¨Ø§ÛŒØ¯ ÛŒÙˆÙ†ÛŒÚ© Ø¨Ø§Ø´Ù‡)
                email: document.getElementById('student-email').value || null // VARCHAR(255) NULLABLE - Ø§ÛŒÙ…ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
            };

            try {
                const response = await fetch('/api/students/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData)
                });

                if (response.ok) {
                    e.target.reset();
                    showMessage('Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
                    await loadAllData(); // Refresh data
                } else {
                    const errorData = await response.json();
                    showMessage(errorData.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²', 'error');
                }
            } catch (error) {
                console.error('Error adding student:', error);
                showMessage(error, 'error');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²';
        });

        // Search students
        document.getElementById('students-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm === '') {
                filteredStudents = allStudents;
            } else {
                filteredStudents = allStudents.filter(student => 
                    student.name.toLowerCase().includes(searchTerm) ||
                    student.national_id.includes(searchTerm) ||
                    (student.email && student.email.toLowerCase().includes(searchTerm))
                );
            }
            
            renderStudents(filteredStudents);
        });

        // Delete student
async function deleteStudent(studentId) {
    try {
        const response = await fetch(`/api/students/delete/${studentId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
            showMessage(data.message || 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø­Ø°Ù Ø´Ø¯', 'success');
            await loadAllData(); // Refresh data
        } else {
            showMessage(data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²', 'error');
        }
    } catch (error) {
        console.error('Error deleting student:', error);
        showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
    }
}


        // ========================================
        // LOANS MANAGEMENT SECTION
        // ========================================
        
        // Add new loan
        document.getElementById('loan-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...';

            const bookId = document.getElementById('loan-book').value;
            const studentId = document.getElementById('loan-student').value;
            
            const borrowDate = new Date();
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 14); // 2 weeks loan period

            // Flask API Integration: POST to /api/loans/add
            const loanData = {
                book_id: parseInt(bookId),                          // INTEGER FOREIGN KEY - Ø´Ù†Ø§Ø³Ù‡ Ú©ØªØ§Ø¨ (Ø§Ø² Ø¬Ø¯ÙˆÙ„ books)
                student_id: parseInt(studentId),                   // INTEGER FOREIGN KEY - Ø´Ù†Ø§Ø³Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² (Ø§Ø² Ø¬Ø¯ÙˆÙ„ students)
                borrow_date: borrowDate.toISOString().split('T')[0], // DATE - ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª (ÙØ±Ù…Øª: YYYY-MM-DD)
                due_date: dueDate.toISOString().split('T')[0],      // DATE - Ù…Ù‡Ù„Øª Ø¨Ø±Ú¯Ø´Øª (ÙØ±Ù…Øª: YYYY-MM-DD)
                returned: false                                     // BOOLEAN DEFAULT FALSE - ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ú¯Ø´Øª
            };

            try {
                const response = await fetch('/api/loans/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loanData)
                });

                if (response.ok) {
                    e.target.reset();
                    showMessage('Ø§Ù…Ø§Ù†Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯', 'success');
                    await loadAllData(); // Refresh data
                } else {
                    const errorData = await response.json();
                    showMessage(errorData.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª', 'error');
                }
            } catch (error) {
                console.error('Error adding loan:', error);
                showMessage(error, 'error');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª';
        });

        // Search loans
        document.getElementById('loans-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm === '') {
                filteredLoans = allLoans;
            } else {
                filteredLoans = allLoans.filter(loan => {
                    const book = allBooks.find(b => b.id === loan.book_id);
                    const student = allStudents.find(s => s.id === loan.student_id);
                    
                    return (book && book.title.toLowerCase().includes(searchTerm)) ||
                           (book && book.author.toLowerCase().includes(searchTerm)) ||
                           (student && student.name.toLowerCase().includes(searchTerm)) ||
                           (student && student.national_id.includes(searchTerm));
                });
            }
            
            renderLoans(filteredLoans, allBooks, allStudents);
        });

        // Return book
        async function returnBook(loanId, bookId) {
            try {
                // Flask API Integration: PUT to /api/loans/return/{loan_id}
                const response = await fetch(`/api/loans/return/${loanId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ book_id: parseInt(bookId) })
                });

                if (response.ok) {
                    showMessage('Ú©ØªØ§Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯', 'success');
                    await loadAllData(); // Refresh data
                } else {
                    const errorData = await response.json();
                    showMessage(errorData.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ú¯Ø´Øª Ú©ØªØ§Ø¨', 'error');
                }
            } catch (error) {
                console.error('Error returning book:', error);
                showMessage(error, 'error');
            }
        }

        // ========================================
        // OVERDUE LOANS SECTION
        // ========================================
        
        // Render overdue loans
        function renderOverdueLoans(loans, books, students) {
            const container = document.getElementById('overdue-list');
            const countElement = document.getElementById('overdue-count');
            
            // Filter overdue loans
            const today = new Date();
            const overdueLoans = loans.filter(loan => {
                if (loan.returned) return false;
                const dueDate = new Date(loan.due_date);
                return dueDate < today;
            });

            countElement.textContent = `${overdueLoans.length} Ù…ÙˆØ±Ø¯`;

            if (overdueLoans.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">âœ…</div>
                        <h3 class="text-xl font-semibold text-green-600 mb-2">Ø¹Ø§Ù„ÛŒ! Ù‡ÛŒÚ† Ø§Ù…Ø§Ù†Øª Ù…Ø¹ÙˆÙ‚Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</h3>
                        <p class="text-gray-500">Ù‡Ù…Ù‡ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ù‡Ù„Øª Ù…Ù‚Ø±Ø± Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = overdueLoans.map(loan => {
                const book = books.find(b => b.id === loan.book_id);
                const student = students.find(s => s.id === loan.student_id);
                const dueDate = new Date(loan.due_date);
                const overdueDays = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));

                return `
                    <div class="border-2 border-red-300 rounded-lg p-6 bg-red-50">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center mb-3">
                                    <span class="text-2xl ml-3">ğŸš¨</span>
                                    <h3 class="text-xl font-bold text-red-700">${overdueDays} Ø±ÙˆØ² ØªØ§Ø®ÛŒØ±</h3>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div class="bg-white p-4 rounded-lg border border-red-200">
                                        <h4 class="font-semibold text-gray-800 mb-2">ğŸ“š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©ØªØ§Ø¨</h4>
                                        <p class="text-lg font-medium text-gray-900">${book ? book.title : 'Ú©ØªØ§Ø¨ Ø­Ø°Ù Ø´Ø¯Ù‡'}</p>
                                        <p class="text-gray-600">${book ? `Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡: ${book.author}` : 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª'}</p>
                                    </div>
                                    
                                    <div class="bg-white p-4 rounded-lg border border-red-200">
                                        <h4 class="font-semibold text-gray-800 mb-2">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</h4>
                                        <p class="text-lg font-medium text-gray-900">${student ? student.name : 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø­Ø°Ù Ø´Ø¯Ù‡'}</p>
                                        <p class="text-gray-600">${student ? `Ú©Ø¯ Ù…Ù„ÛŒ: ${student.national_id}` : 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª'}</p>
                                        ${student && student.email ? `<p class="text-gray-500 text-sm">Ø§ÛŒÙ…ÛŒÙ„: ${student.email}</p>` : ''}
                                    </div>
                                </div>
                                
                                <div class="bg-white p-4 rounded-lg border border-red-200 mb-4">
                                    <h4 class="font-semibold text-gray-800 mb-2">ğŸ“… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²Ù…Ø§Ù†ÛŒ</h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span class="text-gray-600">ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª:</span>
                                            <span class="font-medium">${new Date(loan.borrow_date).toLocaleDateString('fa-IR')}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Ù…Ù‡Ù„Øª Ø¨Ø±Ú¯Ø´Øª:</span>
                                            <span class="font-medium text-red-600">${dueDate.toLocaleDateString('fa-IR')}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mr-4">
                                <button onclick="returnBook('${loan.id}', '${loan.book_id}')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                                    âœ… Ø¨Ø±Ú¯Ø´Øª Ú©ØªØ§Ø¨
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // RENDER FUNCTIONS
        // ========================================
        
        // Render books list
        function renderBooks(books) {
            const container = document.getElementById('books-list');
            if (books.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Ù‡ÛŒÚ† Ú©ØªØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            container.innerHTML = books.map(book => `
                <div class="border border-gray-200 rounded-lg p-4 ${book.available_copies > 0 ? 'bg-green-50' : 'bg-red-50'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-gray-900">${book.title}</h3>
                            <p class="text-gray-600">Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡: ${book.author}</p>
                            <p class="text-gray-700 font-medium">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„: ${book.total_copies} | Ù…ÙˆØ¬ÙˆØ¯: ${book.available_copies}</p>
                            <span class="inline-block mt-2 px-3 py-1 rounded-full text-sm ${book.available_copies > 0 ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                                ${book.available_copies > 0 ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡'}
                            </span>
                        </div>
                        <button onclick="deleteBook('${book.id}')" class="text-red-600 hover:text-red-800 p-2">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderStudents(students) {
            const container = document.getElementById('students-list');
            if (students.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Ù‡ÛŒÚ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            container.innerHTML = students.map(student => `
                <div class="border border-gray-200 rounded-lg p-4 bg-blue-50">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-gray-900">${student.name}</h3>
                            <p class="text-gray-600">Ú©Ø¯ Ù…Ù„ÛŒ: ${student.national_id}</p>
                            ${student.email ? `<p class="text-gray-500 text-sm">Ø§ÛŒÙ…ÛŒÙ„: ${student.email}</p>` : ''}
                        </div>
                        <button onclick="deleteStudent('${student.id}')" class="text-red-600 hover:text-red-800 p-2">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderLoans(loans, books, students) {
            const container = document.getElementById('loans-list');
            if (loans.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Ù‡ÛŒÚ† Ø§Ù…Ø§Ù†ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            const activeLoans = loans.filter(loan => !loan.returned);
            
            container.innerHTML = activeLoans.map(loan => {
                const book = books.find(b => b.id === loan.book_id);
                const student = students.find(s => s.id === loan.student_id);
                const dueDate = new Date(loan.due_date);
                const today = new Date();
                const isOverdue = dueDate < today;
                const isDueSoon = !isOverdue && (dueDate - today) / (1000 * 60 * 60 * 24) <= 3;

                let statusClass = '';
                let statusText = '';
                if (isOverdue) {
                    statusClass = 'overdue';
                    statusText = 'ğŸš¨ Ù…Ù‡Ù„Øª Ú¯Ø°Ø´ØªÙ‡';
                } else if (isDueSoon) {
                    statusClass = 'due-soon';
                    statusText = 'âš ï¸ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ù…Ù‡Ù„Øª';
                } else {
                    statusClass = 'bg-gray-50';
                    statusText = 'âœ… Ø¯Ø± Ù…Ù‡Ù„Øª';
                }

                return `
                    <div class="border border-gray-200 rounded-lg p-4 ${statusClass}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-semibold text-lg text-gray-900">${book ? book.title : 'Ú©ØªØ§Ø¨ Ø­Ø°Ù Ø´Ø¯Ù‡'}</h3>
                                <p class="text-gray-600">Ø§Ù…Ø§Ù†Øªâ€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡: ${student ? student.name : 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø­Ø°Ù Ø´Ø¯Ù‡'}</p>
                                <p class="text-gray-500 text-sm">ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª: ${new Date(loan.borrow_date).toLocaleDateString('fa-IR')}</p>
                                <p class="text-gray-500 text-sm">Ù…Ù‡Ù„Øª Ø¨Ø±Ú¯Ø´Øª: ${dueDate.toLocaleDateString('fa-IR')}</p>
                                <span class="inline-block mt-2 px-3 py-1 rounded-full text-sm font-medium">
                                    ${statusText}
                                </span>
                            </div>
                            <button onclick="returnBook('${loan.id}', '${loan.book_id}')" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                                Ø¨Ø±Ú¯Ø´Øª Ú©ØªØ§Ø¨
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }



        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        // Show notification message
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // ========================================
        // NAVIGATION FUNCTIONS
        // ========================================
        
        // Show specific section
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + '-section').classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('border-white'));
            document.getElementById(section + '-tab').classList.add('border-white');
        }

        // Update loan select options
        function updateLoanSelects(books, students) {
            const bookSelect = document.getElementById('loan-book');
            const studentSelect = document.getElementById('loan-student');
            
            // Update books dropdown
            bookSelect.innerHTML = '<option value="">Ú©ØªØ§Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>';
            books.filter(book => book.available_copies > 0).forEach(book => {
                bookSelect.innerHTML += `<option value="${book.id}">${book.title} - ${book.author} (Ù…ÙˆØ¬ÙˆØ¯: ${book.available_copies})</option>`;
            });
            
            // Update students dropdown
            studentSelect.innerHTML = '<option value="">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>';
            students.forEach(student => {
                studentSelect.innerHTML += `<option value="${student.id}">${student.name} - ${student.national_id}</option>`;
            });
        }

        // ========================================
        // APP INITIALIZATION
        // ========================================
        
        // Initialize app
        initializeApp();
        showSection('books');
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99953876f3708745',t:'MTc2MjI3MDkzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
